{"version":3,"sources":["../../src/utils/image-bitmap.js"],"names":["fileType","PNG","JPEG","BMP","UTIF","EXIFParser","GIF","constants","throwError","MIME","promisify","getMIMEFromBuffer","buffer","path","fileTypeFromBuffer","mime","getType","getBitmapFromGIF","data","gifObj","GifReader","gifData","Buffer","alloc","width","height","decodeAndBlitFrameRGBA","exifRotate","img","exif","_exif","tags","Orientation","mirror","rotate","parseBitmap","cb","Error","_originalMime","toLowerCase","getMIME","MIME_PNG","png","parse","err","call","bitmap","from","MIME_JPEG","decode","create","MIME_TIFF","ifds","page","decodeImages","rgba","toRGBA8","t256","t257","MIME_BMP","MIME_X_MS_BMP","MIME_GIF","compositeBitmapOverBackground","Jimp","image","_background","composite","getBuffer","AUTO","bitDepth","deflateLevel","_deflateLevel","deflateStrategy","_deflateStrategy","filterType","_filterType","colorType","_rgba","inputHasAlpha","constructor","sync","write","jpeg","encode","_quality","bmp","c","tiff","encodeImage","getBufferAsync"],"mappings":"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","sourcesContent":["import fileType from 'file-type';\n\nimport { PNG } from 'pngjs';\nimport JPEG from 'jpeg-js';\nimport BMP from 'bmp-js';\nimport UTIF from 'utif';\nimport EXIFParser from 'exif-parser';\nimport GIF from 'omggif';\n\nimport * as constants from '../constants';\nimport { throwError } from './error-checking';\nimport * as MIME from './mime';\nimport promisify from './promisify';\n\nfunction getMIMEFromBuffer(buffer, path) {\n    const fileTypeFromBuffer = fileType(buffer);\n\n    if (fileTypeFromBuffer) {\n        // If fileType returns something for buffer, then return the mime given\n        return fileTypeFromBuffer.mime;\n    }\n\n    if (path) {\n        // If a path is supplied, and fileType yields no results, then retry with MIME\n        // Path can be either a file path or a url\n        return MIME.getType(path);\n    }\n\n    return null;\n}\n\n// gets image data from a GIF buffer\nfunction getBitmapFromGIF(data) {\n    const gifObj = new GIF.GifReader(data);\n    const gifData = Buffer.alloc(gifObj.width * gifObj.height * 4);\n\n    gifObj.decodeAndBlitFrameRGBA(0, gifData);\n\n    return {\n        data: gifData,\n        width: gifObj.width,\n        height: gifObj.height\n    };\n}\n\n/*\n * Automagically rotates an image based on its EXIF data (if present)\n * @param img a constants object\n*/\nfunction exifRotate(img) {\n    const exif = img._exif;\n\n    if (exif && exif.tags && exif.tags.Orientation) {\n        switch (img._exif.tags.Orientation) {\n            case 1: // Horizontal (normal)\n                // do nothing\n                break;\n            case 2: // Mirror horizontal\n                img.mirror(true, false);\n                break;\n            case 3: // Rotate 180\n                img.rotate(180, false);\n                break;\n            case 4: // Mirror vertical\n                img.mirror(false, true);\n                break;\n            case 5: // Mirror horizontal and rotate 270 CW\n                img.rotate(-90, false).mirror(true, false);\n                break;\n            case 6: // Rotate 90 CW\n                img.rotate(-90, false);\n                break;\n            case 7: // Mirror horizontal and rotate 90 CW\n                img.rotate(90, false).mirror(true, false);\n                break;\n            case 8: // Rotate 270 CW\n                img.rotate(-270, false);\n                break;\n            default:\n                break;\n        }\n    }\n\n    return img;\n}\n\n// parses a bitmap from the constructor to the JIMP bitmap property\nexport function parseBitmap(data, path, cb) {\n    const mime = getMIMEFromBuffer(data, path);\n\n    if (typeof mime !== 'string') {\n        return cb(new Error('Could not find MIME for Buffer <' + path + '>'));\n    }\n\n    this._originalMime = mime.toLowerCase();\n\n    switch (this.getMIME()) {\n        case constants.MIME_PNG: {\n            const png = new PNG();\n            png.parse(data, (err, data) => {\n                if (err) {\n                    return throwError.call(this, err, cb);\n                }\n\n                this.bitmap = {\n                    data: Buffer.from(data.data),\n                    width: data.width,\n                    height: data.height\n                };\n                cb.call(this, null, this);\n            });\n            break;\n        }\n\n        case constants.MIME_JPEG:\n            try {\n                this.bitmap = JPEG.decode(data);\n\n                try {\n                    this._exif = EXIFParser.create(data).parse();\n                    exifRotate(this); // EXIF data\n                } catch (err) {\n                    /* meh */\n                }\n                cb.call(this, null, this);\n            } catch (err) {\n                cb.call(this, err, this);\n            }\n            break;\n\n        case constants.MIME_TIFF: {\n            const ifds = UTIF.decode(data);\n            const page = ifds[0];\n            UTIF.decodeImages(data, ifds);\n            const rgba = UTIF.toRGBA8(page);\n\n            this.bitmap = {\n                data: Buffer.from(rgba),\n                width: page.t256[0],\n                height: page.t257[0]\n            };\n\n            cb.call(this, null, this);\n            break;\n        }\n\n        case constants.MIME_BMP:\n        case constants.MIME_X_MS_BMP:\n            this.bitmap = BMP.decode(data);\n            cb.call(this, null, this);\n            break;\n\n        case constants.MIME_GIF:\n            this.bitmap = getBitmapFromGIF(data);\n            cb.call(this, null, this);\n            break;\n\n        default:\n            return throwError.call(this, 'Unsupported MIME type: ' + mime, cb);\n    }\n\n    return this;\n}\n\nfunction compositeBitmapOverBackground(Jimp, image) {\n    return new Jimp(\n        image.bitmap.width,\n        image.bitmap.height,\n        image._background\n    ).composite(image, 0, 0).bitmap;\n}\n\n/**\n * Converts the image to a buffer\n * @param {string} mime the mime type of the image buffer to be created\n * @param {function(Error, Jimp)} cb a Node-style function to call with the buffer as the second argument\n * @returns {Jimp} this for chaining of methods\n */\nexport function getBuffer(mime, cb) {\n    if (mime === constants.AUTO) {\n        // allow auto MIME detection\n        mime = this.getMIME();\n    }\n\n    if (typeof mime !== 'string') {\n        return throwError.call(this, 'mime must be a string', cb);\n    }\n\n    if (typeof cb !== 'function') {\n        return throwError.call(this, 'cb must be a function', cb);\n    }\n\n    switch (mime.toLowerCase()) {\n        case constants.MIME_PNG: {\n            const png = new PNG({\n                width: this.bitmap.width,\n                height: this.bitmap.height,\n                bitDepth: 8,\n                deflateLevel: this._deflateLevel,\n                deflateStrategy: this._deflateStrategy,\n                filterType: this._filterType,\n                colorType: this._rgba ? 6 : 2,\n                inputHasAlpha: true\n            });\n\n            if (this._rgba) {\n                png.data = Buffer.from(this.bitmap.data);\n            } else {\n                // when PNG doesn't support alpha\n                png.data = compositeBitmapOverBackground(\n                    this.constructor,\n                    this\n                ).data;\n            }\n\n            const buffer = PNG.sync.write(png);\n            cb.call(this, null, buffer);\n            break;\n        }\n\n        case constants.MIME_JPEG: {\n            // composite onto a new image so that the background shows through alpha channels\n            const jpeg = JPEG.encode(\n                compositeBitmapOverBackground(this.constructor, this),\n                this._quality\n            );\n            cb.call(this, null, jpeg.data);\n            break;\n        }\n\n        case constants.MIME_BMP:\n        case constants.MIME_X_MS_BMP: {\n            // composite onto a new image so that the background shows through alpha channels\n            const bmp = BMP.encode(\n                compositeBitmapOverBackground(this.constructor, this)\n            );\n            cb.call(this, null, bmp.data);\n            break;\n        }\n\n        case constants.MIME_TIFF: {\n            const c = compositeBitmapOverBackground(this.constructor, this);\n            const tiff = UTIF.encodeImage(c.data, c.width, c.height);\n            cb.call(this, null, Buffer.from(tiff));\n            break;\n        }\n\n        default:\n            cb.call(this, 'Unsupported MIME type: ' + mime);\n            break;\n    }\n\n    return this;\n}\n\nexport function getBufferAsync(mime) {\n    return promisify(getBuffer, this, mime);\n}\n"],"file":"image-bitmap.js"}